---
# Cover state sensor
# vars:
#   uid: <unique identifier for the cover>
#   entity_id: <Home Assistant entity_id for the cover>

text_sensor:
  - id: widget_sensor_${uid}
    platform: homeassistant
    entity_id: ${entity_id}
    on_value:
      - lambda: |-
          // Map cover UIDs to their positions in the cycling pairs
          // Pair 0: kitchen (left), salon (right)
          // Pair 1: main_bedroom (left), julia_bedroom (right)
          // Pair 2: first_bedroom (left), bathroom (right)

          std::string uid = "${uid}";
          std::string state = id(widget_sensor_${uid}).state;
          int current_pair = id(current_cover_pair_index);

          // Determine which pair and position this cover belongs to
          int cover_pair = -1;
          bool is_left = false;

          if (uid == "kitchen") { cover_pair = 0; is_left = true; }
          else if (uid == "salon") { cover_pair = 0; is_left = false; }
          else if (uid == "main_bedroom") { cover_pair = 1; is_left = true; }
          else if (uid == "julia_bedroom") { cover_pair = 1; is_left = false; }
          else if (uid == "first_bedroom") { cover_pair = 2; is_left = true; }
          else if (uid == "bathroom") { cover_pair = 2; is_left = false; }

          // Only update if this cover is part of the PREVIOUS pair (about to be displayed)
          // or the CURRENT pair (currently displayed)
          int prev_pair = (current_pair - 1 + 3) % 3;

          if (cover_pair != current_pair && cover_pair != prev_pair) {
            return; // This cover is not currently displayed
          }

          // Determine colors based on state
          uint32_t color;
          const char* text;

          if (state == "open") {
            color = ${button_on_color};
            text = "OPEN";
          } else if (state == "closed") {
            color = ${button_off_color};
            text = "CLOSED";
          } else if (state == "opening") {
            color = 0xFFC107; // Amber
            text = "OPENING";
          } else if (state == "closing") {
            color = 0xFF9800; // Orange
            text = "CLOSING";
          } else {
            color = 0x9E9E9E; // Grey
            text = "---";
          }

          // Update the appropriate indicator and label
          if (is_left) {
            lv_obj_set_style_bg_color(id(left_cover_indicator), lv_color_hex(color), 0);
            lv_label_set_text(id(left_cover_status), text);
            lv_obj_set_style_text_color(id(left_cover_status), lv_color_hex(color), 0);
          } else {
            lv_obj_set_style_bg_color(id(right_cover_indicator), lv_color_hex(color), 0);
            lv_label_set_text(id(right_cover_status), text);
            lv_obj_set_style_text_color(id(right_cover_status), lv_color_hex(color), 0);
          }

          ESP_LOGD("cover_state", "Cover %s: %s (pair %d, %s)",
                   uid.c_str(), text, cover_pair, is_left ? "left" : "right");
